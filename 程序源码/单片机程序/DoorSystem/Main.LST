C51 COMPILER V7.02a   MAIN                                                                 01/15/2015 15:58:45 PAGE 1   


C51 COMPILER V7.02a, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN Main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE Main.c BROWSE DEBUG OBJECTEXTEND TABS(2)

stmt level    source

   1          //*****************************************************   
   2          //*     FineName£º    Main.c                          *
   3          //*     Created:      2015.1.1                        * 
   4          //*     Last Change:  2015.1.15                        *
   5          //*     Author:       FanChangFu                      *         
   6          //*     Compiler:     KEIL C51 uVision4.0             *
   7          //*     CPU:          STC89C52RC                      *
   8          //*     Description:  DoorSystems                     *             
   9          //*     OSC use 12MHz crystal.                        *
  10          //*****************************************************
  11          
  12          #include "Main.h"
  13          
  14          /*----------------Ö÷º¯Êý------------------------------*/
  15          void main()
  16          {
  17   1          SystemInit();                     //ÏµÍ³³õÊ¼»¯
  18   1          user_number=ReadEEPROM(0x26,0x00);//¶ÁÏµÍ³ÓÃ»§Êý
  19   1          WDTFunction();                    //Î¹¹·
  20   1          while(1)
  21   1          {
  22   2             
  23   2             if(find_card==TRUE)                        //Èç¹ûÓÐ¿¨½øÈëÉäÆµÄ£¿éÇøÓò£¬×öÏÂÃæ´¦Àí
  24   2             {
  25   3                ET1=0;                                  //½ûÖ¹¶¨Ê±Æ÷1ÖÐ¶Ï£¬±ÜÃâ¸ÉÈÅ             
  26   3                SearchCardData();                       //ÏòÉäÆµÄ£¿é·¢ËÍ¶ÁÈ¡¿¨Æ¬EEPROMÖ¸Áî      
  27   3                TR0=1;                                  //Æô¶¯¶¨Ê±Æ÷1£¨¶¨Ê±Æ÷1¶¨Ê±Ô¼300ms£©
  28   3                while( tf0_flag==FALSE);                //Ò»Ö±whileÑ­»·£¬µÈ´ý300ms£¨300msºó£¬¶¨Ê±Æ÷1ÖÐ¶Ï´¦Àíº¯ÊýÖÐ»áÉ
             -èÖÃtf0_flag=TRUE)£»ÑÓÊ±300msÄ¿µÄÊÇµÈ´ý´®¿Ú½ÓÊÕÍêÉäÆµÄ£¿é·¢»ØÀ´µÄÊý¾Ý¡£
  29   3                tf0_flag=FALSE;                         //tf0_flagÖØÐÂ±ê¼ÇÎªFALSE
  30   3                if(recv_command_success_flag==SUCCESS)  //ÈçºÎÕýÈ·½ÓÊÕµ½ÉäÆµÄ£¿é·¢»ØÀ´µÄÊý¾Ý£¨¿¨ÐòÁÐºÅ),×öÏÂÃæ´¦Àí¡£
  31   3                {            
  32   4                   if(MatchCardData()==SUCCESS)         //Êý¾ÝÆ¥Åä
  33   4                   {             
  34   5                       SearchCard();                    //ÏòÉäÆµÄ£¿é·¢ËÍÑ°¿¨Ö¸Áî
  35   5                       TR0=1;                  
  36   5                       while( tf0_flag==FALSE);
  37   5                       tf0_flag=FALSE;
  38   5                       if(recv_command_success_flag==SUCCESS)
  39   5                       {                 
  40   6                          if(MatchCardSN()==SUCCESS)   //Æ¥Åä¿¨ÐòÁÐºÅ
  41   6                          {
  42   7                             OpenDoor();               //¿ªÃÅ
  43   7                          }
  44   6                       }
  45   5                   }   
  46   4                }
  47   3                find_card=FALSE;                       //find_cardÖØÐÂ±ê¼ÇÎªFALSE
  48   3                ET1=1;                                 //ÖØÐÂ¿ªÆô¶¨Ê±Æ÷1ÖÐ¶Ï
  49   3             }
  50   2          }
  51   1      }
  52          /*-----------------------------------------------------*/
  53          
  54          
C51 COMPILER V7.02a   MAIN                                                                 01/15/2015 15:58:45 PAGE 2   

  55          /*-------------------------------------------------  ÏµÍ³³õÊ¼»¯ÉèÖÃ---------------------------------------
             -----------------------*/
  56          /*---ÏµÍ³³õÊ¼»¯º¯Êý---*/
  57          void SystemInit()
  58          {
  59   1          BaudRateSetup();   //ÉèÖÃ²¨ÌØÂÊ
  60   1          SerialPortSetup(); //ÉèÖÃ´®¿Ú
  61   1          INT0Setup();       //ÉèÖÃÍâ²¿ÖÐ¶Ï0
  62   1          IpSetup();         //ÉèÖÃÖÐ¶ÏÓÅÏÈ¼¶
  63   1          Tf0AndTf1Setup();  //ÉèÖÃ¶¨Ê±Æ÷0¡¢¶¨Ê±Æ÷1
  64   1          
  65   1          find_card=FALSE;//È«¾Ö±äÁ¿³õÊ¼»¯
  66   1          recv_aa=FALSE;
  67   1          led_flag=FALSE;
  68   1          recv_num=0;
  69   1          recv_command_success_flag=FAIL;
  70   1          tf1_num=0;
  71   1          tf0_num=0;
  72   1          tf0_flag=FALSE;
  73   1          
  74   1          TR2=1;//Æô¶¯²¨ÌØÂÊ·¢ÉúÆ÷
  75   1          TR1=1;//Æô¶¯¶¨Ê±Æ÷1
  76   1          ES=1; //Æô¶¯´®¿ÚÖÐ¶Ï
  77   1          EA=1; //¿ª·ÅËùÓÐÖÐ¶Ï
  78   1      } 
  79          
  80          
  81          /*---ÉèÖÃ²¨ÌØÂÊ---*/
  82            //¶¨Ê±Æ÷2×÷Îª²¨ÌØÂÊ·¢ÉúÆ÷Ê±£¬²¨ÌØÂÊ¼ÆËã¹«Ê½£º²¨ÌØÂÊ=Õñµ´Æ÷ÆµÂÊ/32[65536-(RCAP2H*256+RCAP2L)]
  83            //¶¨Ê±Æ÷2×÷Îª²¨ÌØÂÊ·¢ÉúÆ÷Ê±£¬»á×Ô¶¯ÖØ×°RCAP2H/RCAP2Lµ½TH2/TL2
  84          void BaudRateSetup()
  85          {
  86   1          RCLK=1;     //ÉèÖÃ¶¨Ê±Æ÷T2×÷Îª²¨ÌØÂÊ·¢ÉúÆ÷
  87   1          TCLK=1;
  88   1          TH2=255;    //²¨ÌØÂÊÎª19200,¶¨Ê±Æ÷³õÖµÒªÉèÎª255*256+236
  89   1          TL2=236;
  90   1          RCAP2H=255; //ÉèÖÃ×Ô¶¯ÖØ×°Öµ£¬Óë³õÖµÏàÍ¬
  91   1          RCAP2L=236;
  92   1          C_T2=0;     //¶¨Ê±Æ÷2²ÉÓÃ¶¨Ê±·½Ê½£¨C_T2=1ÊÇ¶ÔÍâ²¿Òý½ÅÂö³å¼ÆÊý)
  93   1      }
  94          
  95          
  96          /*---ÉèÖÃ´®¿Ú---*/
  97          void SerialPortSetup()
  98          {
  99   1          SM0=0; //´®¿Ú¹¤×÷·½Ê½:10Î»Òì²½ÊÕ·¢(8Î»Êý¾ÝÎ»£¬Ò»Î»¿ªÊ¼Î»£¬Ò»Î»Í£Ö¹Î»)
 100   1          SM1=1;
 101   1          REN=1;
 102   1          ES=1;  //ÔÊÐí´®ÐÐ¿ÚÖÐ¶Ï£¬´®¿ÚÊý¾ÝµÄÊÕ·¢²ÉÓÃÖÐ¶Ï·½Ê½
 103   1      }
 104          
 105          
 106          /*---Íâ²¿ÖÐ¶Ï0ÉèÖÃ---*/   
 107          void INT0Setup()
 108          {
 109   1          IT0=1; //ÏÂ½µÑØ´¥·¢
 110   1          EX0=1; //ÔÊÐíÍâ²¿ÖÐ¶Ï0ÖÐ¶Ï
 111   1      }
 112          
 113          
 114          /*---¶¨Ê±Æ÷0ºÍ¶¨Ê±Æ÷1ÉèÖÃ---*/
 115            //¶¨Ê±Æ÷1¶¨Ê±3s£¨ÐèÒª¶¨Ê±Æ÷ÖÐ¶Ï45´Î£©£¬¶¨Ê±Æ÷0¶¨Ê±250ºÁÃë£¨ÐèÒª¶¨Ê±Æ÷ÖÐ¶Ï4´Î)
C51 COMPILER V7.02a   MAIN                                                                 01/15/2015 15:58:45 PAGE 3   

 116          void Tf0AndTf1Setup()
 117          {
 118   1         TMOD=0x11;//¶¨Ê±Æ÷0ºÍ¶¨Ê±Æ÷1¶¼Ê¹ÓÃ¹¤×÷Ä£Ê½1£º16Î»¼ÆÊý£¬×î´ó¼ÆÊý´ÎÊý65536
 119   1         TH0=0;    //¶¨Ê±Æ÷0³õÊ¼¼ÆÊýÖµÉèÎª0
 120   1         TL0=0;
 121   1         TH1=0;    //¶¨Ê±Æ÷1³õÊ¼¼ÆÊýÖµÉèÎª1
 122   1         TL1=0;
 123   1         ET0=1;    //ÔÊÐí¶¨Ê±Æ÷0¡¢¶¨Ê±Æ÷1ÖÐ¶Ï
 124   1         ET1=1; 
 125   1      }
 126          
 127          
 128          /*---ÖÐ¶ÏÓÅÏÈ¼¶ÉèÖÃ---*/
 129            //´®¿ÚÖÐ¶Ï¡¢Íâ²¿ÖÐ¶ÏÓÅÏÈ¼¶±ðÉèÎª1£¬¶¨Ê±Æ÷0¡¢¶¨Ê±Æ÷1ÖÐ¶ÏÓÅÏÈ¼¶±ðÉèÖÃÎª0
 130          void IpSetup()
 131          {
 132   1          PS=1;
 133   1          PX0=1;
 134   1          PT0=0;
 135   1          PT1=0;
 136   1      } 
 137          /*--------------------------------------------------------------------------------------------------------
             -----------------------*/
 138          
 139          
 140          
 141          
 142          
 143          /*---------------------------------------------------ÖÐ¶Ï´¦Àíº¯Êý-----------------------------------------
             ------------------------*/
 144          /*---¶¨Ê±Æ÷1ÖÐ¶Ï´¦Àíº¯Êý---*/
 145            //ÔÚ¸Ãº¯ÊýÖÐ¿ØÖÆÉäÆµÄ£¿éµÄLedµÆµÄÉÁË¸£¬Ô¼3sÉÁË¸Ò»´Î
 146            //¶¨Ê±Æ÷ÖÐ¶Ï45´ÎµÄÊ±¼äÔ¼Îª3s
 147          Tf1_interrupt() interrupt 3
 148          {
 149   1         WDTFunction();//Î¹¹·
 150   1         tf1_num=tf1_num+1;  //¶¨Ê±Æ÷Ã¿ÖÐ¶ÏÒ»´Îºó¼Ó1
 151   1         if(tf1_num>45)
 152   1         {
 153   2            TR1=0;          //ÏÈÍ£Ö¹¶¨Ê±Æ÷1¹¤×÷
 154   2            SetLedOn();     //µãÁÁLedµÆ
 155   2            Delay(1000,10); //ÑÓÊ±Ò»¶ÎÊ±¼ä
 156   2            SetLedOff();    //¹Ø±ÕLedµÆ
 157   2            TR1=1;          //ÖØÐÂÆô¶¯¶¨Ê±Æ÷1
 158   2            tf1_num=0;      //tf1_numÇåÁã£¬¿ªÊ¼ÏÂÒ»ÂÖ¼ÆÊý
 159   2         }
 160   1         TH1=0;   //¶¨Ê±Æ÷ÖÐ¶Ïºó£¬ÖØÐÂÉè¶¨ÏÂÒ»´Î¼ÆÊ±µÄ³õÖµ±
 161   1         TL1=0;
 162   1      }
 163          
 164          
 165          /*---¶¨Ê±Æ÷0ÖÐ¶Ï´¦Àíº¯Êý---*/
 166            //ÔÚmainº¯ÊýÖÐµ÷ÓÃSearchCard()ºÍSearchCardData()º¯ÊýºóÆô¶¯¶¨Ê±Æ÷0£¬ÑÓÊ±Ô¼300ms£¬µÈ´ý½ÓÊÕÍêÉäÆµÄ£¿é·¢¹ýÀ´
             -µÄÊý¾Ý¡£
 167            //¶¨Ê±Æ÷ÖÐ¶Ï4´ÎµÄÊ±¼äÔ¼Îª300ms
 168          Tf0_interrupt() interrupt 1
 169          {
 170   1          WDTFunction();//Î¹¹·
 171   1          tf0_num=tf0_num+1;  //¶¨Ê±Æ÷Ã¿ÖÐ¶ÏÒ»´Îºó¼Ó1
 172   1          if(tf0_num>=4)
 173   1          {
 174   2             TR0=0;           //¹Ø±Õ¶¨Ê±Æ÷0£¨¶¨Ê±Æ÷0ÔÚmainº¯Êýµ÷ÓÃSearchCard()ºÍSearchCardData()º¯ÊýºóÆô¶¯£©
C51 COMPILER V7.02a   MAIN                                                                 01/15/2015 15:58:45 PAGE 4   

 175   2             tf0_flag=TRUE;   //±ê¼ÇÉèÎªTRUE¸æËßmainº¯ÊýÊý¾Ý½ÓÊÕÍê±Ï£¬·ñÔòmainº¯Êý»áÔÚwhile( tf0_flag==FALSE)Óï¾äÖÐ
             -²»¶ÏÑ­»·
 176   2             tf0_num=0;       //ÇåÁã
 177   2          }
 178   1      }    
 179            
 180            
 181          /*---Íâ²¿ÖÐ¶Ï0ÖÐ¶Ï´¦Àíº¯Êý---*/
 182            //µ±ÓÐ¿¨¿¿½üÉäÆµÄ£¿éÊ±£¬SIGÒý½Å³öÏÖµÍµçÆ½£¬´¥·¢µ¥Æ¬»úµÄÍâ²¿ÖÐ¶Ï0·¢ÉúÖÐ¶Ï
 183          Int0_interrupt() interrupt 0
 184          {
 185   1          EA=0;          //Îª±ÜÃâ¸ÉÈÅ£¬ÏÈ¹Ø±Õ×ÜÖÐ¶Ï
 186   1          find_card=TRUE;//±ê¼ÇÓÐ¿¨¿¿½üÉäÆµÄ£¿é
 187   1          EA=1;          //ÖØÐÂ¿ªÖÐ¶Ï
 188   1      }
 189          
 190          
 191          /*---´®¿ÚÖÐ¶Ï´¦Àíº¯Êý---*/
 192            //ÔÚ¸Ãº¯ÊýÖÐÍê³É´®¿ÚÊý¾ÝµÄ½ÓÊÕ£¨´®¿ÚÊý¾Ý½ÓÊÕ²ÉÓÃÖÐ¶Ï·½Ê½£©
 193            //¸ù¾ÝYHY502C_v2.5_CN.pfdÎÄµµÖÐµÄÉäÆµÄ£¿é·¢ËÍÊý¾ÝµÄ¸ñÊ½£¬Èôµ±Ç°µ¥Æ¬»úÊÕµ½µÄ×Ö½ÚÎª0xaa,½ô½Ó×ÅÊÕµ½µÄ×Ö½ÚÖ»
             -ÓÐÁ½ÖÖÇé¿ö£º0xbb(±íÊ¾0xaaºÍ0xbbÊÇÖ¡ÃüÁîÍ·),0x00(±íÊ¾0xaaÊÇÊý¾Ý£¬²»ÊÇÖ¡ÃüÁîÍ·)
 194          SerialPort_interrupt() interrupt 4
 195          {
 196   1          unsigned char recv_byte;  //¸Ã±äÁ¿ÓÃÓÚÔÝÊ±±£´æ´®¿Ú½ÓÊÕµÄÒ»¸ö×Ö½ÚÊý¾ÝÚ
 197   1          unsigned char check_sum;  //Ò»Ö¡Êý¾Ý½ÓÊÕÍê±Ïºó£¬¸Ã±äÁ¿ÓÃÓÚÒì»òÐ£Ñé
 198   1          int i;
 199   1          EA=0;     //Îª·ÀÖ¹¸ÉÈÅ£¬ÏÈ¹Ø±Õ×ÜÖÐ¶Ï  
 200   1          if(RI==1) //ÅÐ¶ÏÊÇ·ñÊÇ´®¿ÚÊÕµ½Êý¾Ý¶øÒý·¢´®¿ÚÖÐ¶Ï£¬ÊÇµÄ»°ÔÚÕâÀïÍê³ÉÊý¾ÝµÄ½ÓÊÕ¹¤×÷
 201   1          {
 202   2             recv_byte=SBUF;//¿½±´´®¿Ú½ÓÊÕ»º´æÖÐµÄÊý¾Ý
 203   2             RI=0;          //ÇåÁã£¬ÓÃÓÚÏÂÒ»´ÎÅÐ¶Ï
 204   2             if(recv_aa==TRUE)   //ÅÐ¶ÏÉÏÒ»´Î½ÓÊÕµÄÊý¾ÝÊÇ·ñÊÇ0xaa
 205   2             {
 206   3                if(recv_byte==0xbb)  //ÉÏ´Î½ÓÊÕµÄ0xaaÊÇÖ¡ÃüÁîÍ·
 207   3                {
 208   4                    recv_aa=FALSE;   //±ê¼ÇFALSE,ÏÂÒ»´ÎÅÐ¶ÏÊ±ÓÃÓÚÖ¸Ê¾Ç°Ò»´Î½ÓÊÕµÄ²»ÊÇ0xaaÏ
 209   4                    recv_num=0;      //»º´ærecv_buf²»±£´æÃüÁîÍ·0xaa0xbb,recv_numÖµÉèÎª0Ïàµ±Çå³ýµôÖ®Ç°±£´æµÄ0xaa0xbb
 210   4                }
 211   3                else if(recv_byte==0x00) //ÉÏ´Î½ÓÊÕµÄ0xaaÊÇÊý¾Ý£¨0x00ÊÇÎªÁËÇø±ðÖ¡ÃüÁîÍ·0xaa0xbb¶øÌí¼Ó½øÈ¥£¬²»ÊÇÎÒÃÇ
             -ÐèÒªµÄÊý¾Ý)
 212   3                {  
 213   4                    recv_aa=FALSE;   //±ê¼ÇFALSE,ÏÂÒ»´ÎÅÐ¶ÏÊ±ÓÃÓÚÖ¸Ê¾Ç°Ò»´Î½ÓÊÕµÄ²»ÊÇ0xaa
 214   4                }
 215   3                else                 //ÆäËûÒâÍâÇé¿ö£¬Õý³£Çé¿öÏÂÖ»»áÊÇ0xbbºÍ0x00
 216   3                {
 217   4                    recv_aa=FALSE;   //±ê¼ÇFALSE,ÏÂÒ»´ÎÅÐ¶ÏÊ±ÓÃÓÚÖ¸Ê¾Ç°Ò»´Î½ÓÊÕµÄ²»ÊÇ0xaa
 218   4                }
 219   3             }
 220   2             else   //ÉÏÒ»´Î½ÓÊÕµÄÊý¾Ý²»ÊÇ0xaa
 221   2             {
 222   3                if(recv_byte==0xaa)  //ÅÐ¶Ïµ±Ç°½ÓÊÕµÄÊý¾ÝÊÇ·ñÊÇ0xaa£¬ÈôÊÇÔò½øÐÐ±ê¼Ç
 223   3                {
 224   4                   recv_aa=TRUE;
 225   4                }
 226   3                recv_buf[recv_num]=recv_byte;//½«½ÓÊÕµ½µÄÊý¾Ý±£´æµ½»º´ærecv_buf
 227   3                recv_num=recv_num+1;         //Ã¿½ÓÊÕ±£´æÒ»¸ö×Ö½ÚÊý¾Ý£¬recv_numÔö1
 228   3                if(recv_num>recv_buf[0])     //recv_buf±£´æµÄÊÇÊý¾ÝÖ¡µÄ³¤¶È×Ö£¬µ±recv_num´óÓÚ³¤¶È×ÖÊ±£¬Ïàµ±ÓÚµ±Ç°½ÓÊÕ
             -µÄÊý¾ÝÊÇÖ¡µÄ×îºóÒ»¸ö×Ö½ÚÊý¾Ý£¬¼´Ò»Ö¡Êý¾Ý½ÓÊÕÍê±ÏÝ
 229   3                {
 230   4                    check_sum=0;
 231   4                    for(i=0;i<recv_buf[0]+1;i++) //¶ÔÒ»Ö¡Êý¾Ý½øÐÐÒì»òÐ£Ñé
 232   4                    {
C51 COMPILER V7.02a   MAIN                                                                 01/15/2015 15:58:45 PAGE 5   

 233   5                       check_sum=check_sum^recv_buf[i];
 234   5                    }
 235   4                    if(check_sum==0)            //Ö¡µÄ×îºóÒ»¸ö×Ö½ÚÎª¼ìÑéÂë£¬ÉÏÃæ½«Ð£ÑéÂëÒ»Æð½øÐÐÒì»òÔËËã£¬Èô½ÓÊÕµÄÊý¾ÝÃ
             -»ÓÐ´íÎó£¬ÄÇcheck_sumµÃÖµÒ»¶¨ÊÇ0
 236   4                    {
 237   5                       if(EppromHandle()==FALSE)
 238   5                       {
 239   6                          recv_command_success_flag=SUCCESS; //±ê¼Ç³É¹¦½ÓÊÕÒ»Ö¡Êý¾Ý£¬¹©mainº¯Êý×öÅÐ¶ÏÊ¹ÓÃ¡£
 240   6                       }
 241   5                    }
 242   4                    recv_num=0;
 243   4                    recv_aa=FALSE;
 244   4                }
 245   3                if(recv_num>=max_num)   //ÅÐ¶Ï½ÓÊÕµÄÊý¾Ý×Ö½ÚÊýÊÇ·ñ´óÓÚ»º´ærecv_buf£¬·ÀÖ¹ÄÚ´æÒç³öÚ
 246   3                {
 247   4                   recv_num=0;
 248   4                   recv_aa=FALSE;
 249   4                }
 250   3             }  
 251   2             
 252   2             
 253   2          }
 254   1          if(TI==1) //±íÊ¾´®¿Ú·¢ËÍÊý¾ÝÒý·¢´®¿ÚÖÐ¶Ï,ÔÚ±¾ÏµÍ³ÖÐ²»Ê¹ÓÃÖÐ¶Ï·½Ê½·¢ËÍÊý¾Ý£¬Ê¹ÓÃ²éÑ¯·½Ê½·¢ËÍÊý¾Ý
 255   1          {
 256   2             TI=0;
 257   2          }
 258   1          EA=1; //ÖØÐÂ¿ªÖÐ¶Ï    
 259   1      }
 260          /*--------------------------------------------------------------------------------------------------------
             --------------------------------*/
 261          
 262          
 263          
 264          
 265          /*--------------------------------------------------ÏòÉäÆµÄ£¿é·¢ËÍÖ¸Áî------------------------------------
             ---------------------------------*/
 266          /*---ÉäÆµÄ£¿é·¢ËÍ´ò¿ªLEDµÆÖ¸Áî---*/
 267            //ÉäÆµÄ£¿éµÄOUT1Òý½ÅÓëLedÕý¼«ÏàÁ¬
 268          void SetLedOn()
 269          {
 270   1         unsigned char command_set_out1_0[6]={0xaa,0xbb,0x03,0x16,0x00,0x15}; //Ö¸Áî£¬¿ØÖÆÉäÆµÄ£¿éµÄOUT1Òý½ÅÊä³ö
             -¸ßµçÆ½?
 271   1         int i;
 272   1         ES=0;  //Ê¹ÓÃ²éÑ¯·½Ê½·¢ËÍ´®¿ÚÊý¾ÝÊ±£¬Òª¹Ø±Õ´®¿ÚÖÐ¶Ï£¬·ñÔò·¢ËÍ²»ÕýÈ·
 273   1         for(i=0;i<6;i++) //²éÑ¯·½Ê½·¢ËÍÊý¾Ý
 274   1         {
 275   2             TI=0;
 276   2             SBUF=command_set_out1_0[i];
 277   2             while(TI==0);
 278   2         }
 279   1         TI=0;
 280   1         ES=1;
 281   1      }
 282          
 283          
 284          /*---ÏòÉäÆµÄ£¿é·¢ËÍ¹Ø±ÕLEDµÆÖ¸Áî---*/
 285          void SetLedOff()
 286          {
 287   1         unsigned char command_set_out1_1[6]={0xaa,0xbb,0x03,0x16,0x01,0x14}; //Ö¸Áî£¬¿ØÖÆÉäÆµÄ£¿éµÄOUT1Òý½ÅÊä³ö
             -µÍµçÆ½
 288   1         int i;
 289   1         ES=0;                                                                //Ê¹ÓÃ²éÑ¯·½Ê½·¢ËÍ´®¿ÚÊý¾ÝÊ±£¬Òª¹Ø±
C51 COMPILER V7.02a   MAIN                                                                 01/15/2015 15:58:45 PAGE 6   

             -Õ´®¿ÚÖÐ¶Ï£¬·ñÔò·¢ËÍ²»ÕýÈ·
 290   1         for(i=0;i<6;i++)                                                     //²éÑ¯·½Ê½·¢ËÍÊý¾Ý
 291   1         {
 292   2             TI=0;
 293   2             SBUF=command_set_out1_1[i];
 294   2             while(TI==0);
 295   2         }
 296   1         TI=0;
 297   1         ES=1;
 298   1      }
 299          
 300          
 301          /*---ÏòÉäÆµÄ£¿éµÄ·¢ËÍÑ°¿¨Ö¸Áî---*/
 302          void SearchCard()
 303          {
 304   1         int i;
 305   1         unsigned char command_search_card[5]={0xaa,0xbb,0x02,0x20,0x22};//Ñ°¿¨Ö¸Áî
 306   1         recv_command_success_flag=FAIL;                                 //·¢ËÍÖ¸ÁîÖ®Ç°ÏÈÉèÖÃFAIL,µ±´®¿ÚÖÐ¶Ï´¦Àíº
             -¯ÊýÖÐÕýÈ·½ÓÊÕÒ»Ö¡Êý¾ÝºóÔÙÉèÖÃÎªSUCCESS,¹©mainº¯Êý×öÅÐ¶ÏÊ¹ÓÃ
 307   1         ClearBuf();                                                     //Í¨¹ý´®¿ÚÏòÉäÆµÄ£¿é·¢ËÍÖ¸Áîºó»áÓëÊý¾Ý·µ
             -»Ø£¬ÔÚÕâÀïÌáÇ°¶Ô»º´ærecv_bufÇåÁã
 308   1         ES=0;                                                           //Ê¹ÓÃ²éÑ¯·½Ê½·¢ËÍ´®¿ÚÊý¾ÝÊ±£¬Òª¹Ø±Õ´®¿Ú
             -ÖÐ¶Ï£¬·ñÔò·¢ËÍ²»ÕýÈ·
 309   1         for(i=0;i<5;i++)                                                //²éÑ¯·½Ê½·¢ËÍ´®¿ÚÊý¾Ý
 310   1         {
 311   2             TI=0;
 312   2             SBUF=command_search_card[i];
 313   2             while(TI==0);
 314   2         }
 315   1         TI=0;
 316   1         ES=1;                                                          //·¢ËÍÍêºóÖØÐÂ¿ªÆô´®¿ÚÖÐ¶Ï
 317   1      }
 318          
 319          
 320          /*---ÏòÉäÆµÄ£¿é·¢ËÍ¶Á¿¨Æ¬EEPROMÊý¾Ý---*/
 321            //¶Á¿¨Æ¬EEPROMÖÐµÄµÚ10,14,18,22¿éÖÐµÄÊý¾Ý£¬¿éÖÐ±£´æµÄÊý¾Ý xx xx xx xx xx xx xx fb 10 25 52 xx xx xx xx x
             -x (xx¿ÉÎªÈÎÒâÊý¾Ý£¬fb 10 25 52²ÅÊÇÓÃÀ´×öÅÐ¶Ï)
 322            //1ºÅÃÅ¶ÔÓ¦µÚ10¿é£¬2ºÅÃÅ¶ÔÓ¦µÚ14¿é£¬3ºÅÃÅ¶ÔÓ¦µÚ18¿é£¬4ºÅÃÅ¶ÔÓ¦µÚ22¿é
 323          void SearchCardData()
 324          {
 325   1         int i;
 326   1         //unsigned char command_search_card_data[13]={0xaa, 0xbb, 0x0a, 0x21, 0x00, 0x0a, 0xff, 0xff, 0xcc, 0xff
             -, 0x10, 0x26, 0x24};  //1ºÅÃÅ
 327   1         //unsigned char command_search_card_data[13]={0xaa, 0xbb, 0x0a, 0x21, 0x00, 0x0e, 0xff, 0xff, 0xdd, 0xf
             -f, 0x10, 0x26, 0x31};  //2ºÅÃÅ
 328   1           unsigned char command_search_card_data[13]={0xaa, 0xbb, 0x0a, 0x21, 0x00, 0x12, 0xff, 0xff, 0xee, 0xff
             -, 0x10, 0x26, 0x1e};  //3ºÅÃÅ
 329   1         //unsigned char command_search_card_data[13]={0xaa, 0xbb, 0x0a, 0x21, 0x00, 0x0a, 0xff, 0xff, 0xff, 0xff
             -, 0x10, 0x26, 0x17};  //4ºÅÃÅ
 330   1         
 331   1         recv_command_success_flag=FAIL;           //·¢ËÍÖ¸ÁîÖ®Ç°ÏÈÉèÖÃFAIL,µ±´®¿ÚÖÐ¶Ï´¦Àíº¯ÊýÖÐÕýÈ·½ÓÊÕÒ»Ö¡Êý¾Ýº
             -óÔÙÉèÖÃÎªSUCCESS,¹©mainº¯Êý×öÅÐ¶ÏÊ¹ÓÃ
 332   1         ClearBuf();                               //Í¨¹ý´®¿ÚÏòÉäÆµÄ£¿é·¢ËÍÖ¸Áîºó»áÓëÊý¾Ý·µ»Ø£¬ÔÚÕâÀïÌáÇ°¶Ô»º´ære
             -cv_bufÇåÁã
 333   1         ES=0;                                     //Ê¹ÓÃ²éÑ¯·½Ê½·¢ËÍ´®¿ÚÊý¾ÝÊ±£¬Òª¹Ø±Õ´®¿ÚÖÐ¶Ï£¬·ñÔò·¢ËÍ²»ÕýÈ·
 334   1         for(i=0;i<13;i++)                         //²éÑ¯·½Ê½·¢ËÍ´®¿ÚÊý¾Ý
 335   1         {
 336   2             TI=0;
 337   2             SBUF=command_search_card_data[i];
 338   2             while(TI==0);
 339   2         }
 340   1         TI=0;
C51 COMPILER V7.02a   MAIN                                                                 01/15/2015 15:58:45 PAGE 7   

 341   1         ES=1;                                    //·¢ËÍÍêºóÖØÐÂ¿ªÆô´®¿ÚÖÐ¶Ï
 342   1      }
 343          /*--------------------------------------------------------------------------------------------------------
             ---------------------------*/
 344          
 345          
 346          
 347          
 348          /*----------------------------------------------------¶ÔÉäÆµÄ£¿é·¢»ØÀ´µÄÊý¾Ý½øÐÐÐ£Ñé----------------------
             -----------------------------*/
 349          /*---¼ìÑéÉäÆµÄ£¿é·¢»ØÀ´µÄ¿¨ÐòÁÐºÅÔÚµ±Ç°ÏµÍ³ÖÐÊÇ·ñ´æÔÚ---*/
 350          error MatchCardSN()
 351          {
 352   1         int i;
 353   1         unsigned char cardsn[4];
 354   1         unsigned char Haddr;
 355   1         unsigned char Laddr;
 356   1         if(index>=user_number)  //Èç¹ûÓÃ»§ËùÒÔºÅ´óÓÚÏµÍ³ÓÃ»§Êý£¬ËµÃ÷¸ÃÓÃ»§²»ÊÇÏµÍ³µÄÓÃ»§£¬Ö±½ÓÍË³ö
 357   1         {
 358   2             return FAIL;
 359   2         }
 360   1         
 361   1         //´ÓEEPROMÖÐ¶Á¿¨ÐòÁÐºÅÝ
 362   1         for(i=0;i<4;i++)
 363   1         {
 364   2            Haddr=0x20+(index*4+i)/256;
 365   2            Laddr=0x00+(index*4+i)%256;
 366   2            cardsn[i]=ReadEEPROM(Haddr,Laddr);
 367   2         }
 368   1         //Æ¥Åä¿¨ÐòÁÐºÅ
 369   1         if((recv_buf[2]==cardsn[0]) && (recv_buf[3]==cardsn[1]) && (recv_buf[4]==cardsn[2]) && (recv_buf[5]==car
             -dsn[3]))
 370   1         {
 371   2             return SUCCESS;
 372   2         }
 373   1         else
 374   1         {
 375   2             return FAIL;
 376   2         }  
 377   1      }
 378          
 379          /*---Ð£Ñé¿¨Æ¬ÖÐµÄÊý¾ÝÊÇ·ñÕýÈ·---*/
 380            //ÈôÕýÈ·¶Áµ½EEPROMÖÐµÄÊý¾Ý£¬recv_buf[0:18]±£´æµÄÊý¾ÝÊÇ£º ³¤¶È×Ö ÃüÁî×Ö xx xx xx xx xx xx xx fb 10 25 52 
             -xx xx xx xx xx
 381          error MatchCardData()
 382          {
 383   1         if((recv_buf[9]==0xfb)&&(recv_buf[10]==0x10)&&(recv_buf[11]==0x25)&&(recv_buf[12]==0x52)) //Ð£Ñé¿¨Æ¬ÖÐµÄ
             -Êý¾ÝÊÇ·ñÕýÈ·£¬ÕýÈ··µ»ØSUCCESS,´íÎó·µ»ØFAIL
 384   1         {
 385   2            index=recv_buf[2]*256+recv_buf[3];
 386   2            if(index>=user_number)
 387   2            {
 388   3                return FAIL;
 389   3            }
 390   2            else
 391   2            {
 392   3               return SUCCESS;
 393   3            }
 394   2         }
 395   1         else
 396   1         {
 397   2            return FAIL;
C51 COMPILER V7.02a   MAIN                                                                 01/15/2015 15:58:45 PAGE 8   

 398   2         }
 399   1      }
 400          /*--------------------------------------------------------------------------------------------------------
             ------------------------*/
 401          
 402          
 403          
 404          
 405          /*-----------------------------------------ÉäÆµ¿¨Æ¬µÄÐòÁÐºÅºÍEEPROMÊý¾ÝÐ£ÑéÍ¨¹ýºóµÄ´¦Àíº¯Êý---------------
             ---------------------------*/
 406          /*---·äÃùÆ÷Ïì---*/
 407            //µÍµçÆ½Çý¶¯
 408          void BuzzerRang()
 409          {
 410   1         Speaker=0;
 411   1         Delay(1000,10);
 412   1         Speaker=1;
 413   1         
 414   1      }
 415          
 416          
 417          /*--¿ØÖÆ¼ÌµçÆ÷¿ªÃÅ---*/
 418          //µÍµçÆ½Çý¶¯
 419          void OpenDoor()
 420          {
 421   1         Relay=0;
 422   1       //Speaker=0;
 423   1         Led=0;
 424   1         Delay(8000,10);
 425   1         Relay=1;
 426   1      //Speaker=1;
 427   1         Led=1;
 428   1      }
 429          
 430          
 431          /*---´ò¿ªLedµÆ---*/
 432          void OpenLed()
 433          {
 434   1         Led=0;
 435   1         Delay(1000,10);
 436   1         Led=1;
 437   1      }
 438          /*--------------------------------------------------------------------------------------------------------
             ------------------------*/
 439          
 440           
 441             
 442             
 443          /*-------------------------------------------------------EEPROM²Ù×÷---------------------------------------
             ------------------------*/
 444          /*----¶ÁEEPROM----*/
 445          unsigned char ReadEEPROM(unsigned char Haddr,unsigned char Laddr)
 446          {
 447   1          char i=0;
 448   1          unsigned char da;
 449   1          ISP_ADDRH=Haddr; //ËÍµØÖ·
 450   1          ISP_ADDRL=Laddr; 
 451   1          EA=0;            //¹ØÖÐ¶Ï
 452   1          ISP_CONTR=0x81;  //ÉèÖÃµÈ´ýÊ±¼ä,ÔÊÐíISP/IAP²Ù×÷
 453   1          ISP_CMD=0x01;    //ËÍ¶Á×Ö½ÚÃüÁî
 454   1          ISP_TRIG=0x46;   //´¥·¢ÃüÁî
 455   1          ISP_TRIG=0xb9;
C51 COMPILER V7.02a   MAIN                                                                 01/15/2015 15:58:45 PAGE 9   

 456   1          i=0;             //ÑÓÊ±
 457   1          i=0;
 458   1          da=ISP_DATA;     //È¡Êý¾Ý
 459   1          
 460   1          ISP_CONTR=0x00; //³öÓÚ°²È«¿¼ÂÇ£¬·ÀÖ¹ISP/IAPÎó²Ù×÷
 461   1          ISP_CMD=0x00;
 462   1          ISP_TRIG=0x00;
 463   1          ISP_ADDRH=0x00;
 464   1          ISP_ADDRL=0x00;
 465   1          
 466   1          EA=1;            //ÖØÐÂ¿ªÖÐ¶Ï
 467   1          return da;       //·µ»ØÊý¾Ý
 468   1      }
 469          
 470          
 471          /*---±à³ÌEEPROM---*/
 472          void ProgramEEPROM(unsigned char Haddr,unsigned char Laddr,unsigned char da)
 473          {
 474   1         ISP_DATA=da;    //ËÍÊý¾Ý
 475   1         ISP_ADDRH=Haddr;//ËÍµØÖ·
 476   1         ISP_ADDRL=Laddr;
 477   1         EA=0;           //¹ØÖÐ¶Ï
 478   1         ISP_CONTR=0x81; //ÉèÖÃµÈ´ýÊ±¼ä,ÔÊÐíISP/IAP²Ù×÷
 479   1         ISP_CMD=0x02;   //ËÍ±à³ÌÃüÁî
 480   1         ISP_TRIG=0x46;   //´¥·¢ÃüÁî
 481   1         ISP_TRIG=0xb9;
 482   1         
 483   1         ISP_CONTR=0x00;  //³öÓÚ°²È«¿¼ÂÇ£¬·ÀÖ¹ISP/IAPÎó²Ù×÷
 484   1         ISP_CMD=0x00;
 485   1         ISP_TRIG=0x00;
 486   1         ISP_ADDRH=0x00;
 487   1         ISP_ADDRL=0x00;
 488   1         
 489   1         EA=1;            //ÖØÐÂ¿ªÖÐ¶Ï
 490   1          
 491   1      }
 492          
 493          
 494          /*---²Á³ýEEPROM---*/
 495          void EraseEEPROM(unsigned char Haddr,unsigned char Laddr)
 496          {
 497   1         
 498   1         ISP_ADDRH=Haddr; //ËÍµØÖ·
 499   1         ISP_ADDRL=Laddr;
 500   1       //EA=0;            //¹ØÖÐ¶Ï
 501   1         ISP_CONTR=0x81;  //ÉèÖÃµÈ´ýÊ±¼ä,ÔÊÐíISP/IAP²Ù×÷
 502   1         ISP_CMD=0x03;    //ËÍ±à³ÌÃüÁî
 503   1         ISP_TRIG=0x46;   //´¥·¢ÃüÁî
 504   1         ISP_TRIG=0xb9;
 505   1         
 506   1         ISP_CONTR=0x00; //³öÓÚ°²È«¿¼ÂÇ£¬·ÀÖ¹ISP/IAPÎó²Ù×÷
 507   1         ISP_CMD=0x00;
 508   1         ISP_TRIG=0x00;
 509   1         ISP_ADDRH=0x00;
 510   1         ISP_ADDRL=0x00;
 511   1       //EA=1;           //ÖØÐÂ¿ªÖÐ¶Ï
 512   1         
 513   1      }
 514          
 515          /*---´ÓEPPROMÖÐ¶ÁÒ»¸ö¿¨µÄÐòÁÐºÅ,²¢Í¨¹ý´®¿ÚËÍ»ØPC---*/
 516          void ReadCardSnFromEppromToPC()
 517          {
C51 COMPILER V7.02a   MAIN                                                                 01/15/2015 15:58:45 PAGE 10  

 518   1         int i;
 519   1         unsigned char cmd[9]={0xaa,0xbb,0x06,0x50,0x00,0x00,0x00,0x00,0x00};
 520   1         unsigned char Haddr;
 521   1         unsigned char Laddr;
 522   1         unsigned char checksum=0x00;
 523   1         unsigned short idx;
 524   1         
 525   1         idx=recv_buf[2]*256+recv_buf[3];//»ñÈ¡¿¨µÄË÷Òý
 526   1         for(i=0;i<4;i++)                //´ÓEEPROMÖÐ¶Á¿¨ÐòÁÐºÅ,¹¹Ôì»ØËÍÖ¸Áî
 527   1         {
 528   2            Haddr=0x20+(idx*4+i)/256;
 529   2            Laddr=0x00+(idx*4+i)%256;
 530   2            cmd[i+4]=ReadEEPROM(Haddr,Laddr);
 531   2         }
 532   1         for(i=0;i<6;i++)
 533   1         {
 534   2            checksum=checksum^cmd[i+2];
 535   2         }
 536   1         cmd[8]=checksum;
 537   1         
 538   1         //Í¨¹ý´®¿Ú»ØËÍ¸øPC
 539   1         ES=0;            //Ê¹ÓÃ²éÑ¯·½Ê½·¢ËÍ´®¿ÚÊý¾ÝÊ±£¬Òª¹Ø±Õ´®¿ÚÖÐ¶Ï£¬·ñÔò·¢ËÍ²»ÕýÈ·
 540   1         for(i=0;i<9;i++) //²éÑ¯·½Ê½·¢ËÍ´®¿ÚÊý¾Ý
 541   1         {
 542   2             TI=0;
 543   2             SBUF=cmd[i];
 544   2             while(TI==0);
 545   2         }
 546   1         TI=0;
 547   1         ES=1;           //·¢ËÍÍêºóÖØÐÂ¿ªÆô´®¿ÚÖÐ¶Ï 
 548   1      }
 549          
 550          /*---ÍùEEPROMÖÐÐ´Ò»¸ö¿¨µÄÐòÁÐºÅ---*/
 551          void WriteCardSnToEeprom()
 552          {
 553   1         unsigned char cmd[5]={0xaa,0xbb,0x02,0x52,0x50}; //»ØËÍÖ¸Áî
 554   1         unsigned char Haddr;
 555   1         unsigned char Laddr;
 556   1         int i;
 557   1         unsigned short idx;
 558   1         
 559   1         idx=recv_buf[6]*256+recv_buf[7];//¹¹Ôì¿¨µÄË÷Òý
 560   1         for(i=0;i<4;i++)                //ÍùEEPROMÖÐÌí¼ÓÒ»¸ö¿¨µÄÐòÁÐºÅ
 561   1         {
 562   2            Haddr=0x20+(idx*4+i)/256;
 563   2            Laddr=0x00+(idx*4+i)%256;
 564   2            ProgramEEPROM(Haddr,Laddr,recv_buf[i+2]);
 565   2         }
 566   1         //ÏòPC»ØËÍÖ¸Áî
 567   1         ES=0;            //Ê¹ÓÃ²éÑ¯·½Ê½·¢ËÍ´®¿ÚÊý¾ÝÊ±£¬Òª¹Ø±Õ´®¿ÚÖÐ¶Ï£¬·ñÔò·¢ËÍ²»ÕýÈ·
 568   1         for(i=0;i<5;i++) //²éÑ¯·½Ê½·¢ËÍÊý¾Ý
 569   1         {
 570   2            TI=0;
 571   2            SBUF=cmd[i];
 572   2            while(TI==0);
 573   2         }
 574   1         TI=0;
 575   1         ES=1;           //·¢ËÍÍêºóÖØÐÂ¿ªÆô´®¿ÚÖÐ¶Ï 
 576   1      }
 577             
 578             
 579          /*---²Á³ýEERPROMµÄÒ»¸öÉÈÇø---*/
C51 COMPILER V7.02a   MAIN                                                                 01/15/2015 15:58:45 PAGE 11  

 580          void EraseSectorOfEpprom()
 581          {
 582   1         unsigned char cmd[5]={0xaa,0xbb,0x02,0x54,0x56};//»ØËÍ¸øPCµÄÖ¸Áî
 583   1         int i;
 584   1         unsigned char SectorOfNumber=recv_buf[2];       //»ñÈ¡Òª²Á³ýµÄÉÈÇøºÅ
 585   1         if(SectorOfNumber>=1&&SectorOfNumber<=4)
 586   1         {
 587   2            //²Á³ýÉÈÇø
 588   2            switch(SectorOfNumber)
 589   2            {
 590   3               case 1:
 591   3                    EraseEEPROM(0x20,0x00);             //²Á³ýµÚÒ»¸öÉÈÇø
 592   3                    break;
 593   3               case 2:
 594   3                    EraseEEPROM(0x22,0x00);             //²Á³ýµÚ¶þ¸öÉÈÇø
 595   3                    break;
 596   3               case 3:
 597   3                    EraseEEPROM(0x24,0x00);             //²Á³ýµÚÈý¸öÉÈÇø
 598   3                    break;
 599   3               case 4:
 600   3                    EraseEEPROM(0x26,0x00);             //²Á³ýµÚËÄ¸öÉÈÇø
 601   3                    break;
 602   3            }
 603   2            
 604   2            //Ïòpc»ØËÍÖ¸Áî
 605   2            ES=0;            //Ê¹ÓÃ²éÑ¯·½Ê½·¢ËÍ´®¿ÚÊý¾ÝÊ±£¬Òª¹Ø±Õ´®¿ÚÖÐ¶Ï£¬·ñÔò·¢ËÍ²»ÕýÈ·
 606   2            for(i=0;i<5;i++) //²éÑ¯·½Ê½·¢ËÍÊý¾Ý
 607   2            {
 608   3               TI=0;
 609   3               SBUF=cmd[i];
 610   3               while(TI==0);
 611   3            }
 612   2            TI=0;
 613   2            ES=1;
 614   2        }
 615   1      }
 616          
 617          
 618          /*---ÏòEEPROMÖÐÐ´Ò»¸ö×Ö½ÚÊý¾Ý---*/
 619          void WriteOneByteToEpprom()
 620          {
 621   1         unsigned char i;
 622   1         unsigned char cmd[5]={0xaa,0xbb,0x02,0x5a,0x58}; //»ØËÍÖ¸Áî
 623   1         unsigned char Haddr;
 624   1         unsigned char Laddr;
 625   1         unsigned char da;
 626   1         Haddr=recv_buf[2];
 627   1         Laddr=recv_buf[3];
 628   1         da=recv_buf[4];
 629   1         ProgramEEPROM(Haddr,Laddr,da);
 630   1         //ÏòPC·¢ËÍ»ØËÍÖ¸Áî
 631   1         ES=0;             //Ê¹ÓÃ²éÑ¯·½Ê½·¢ËÍ´®¿ÚÊý¾ÝÊ±£¬Òª¹Ø±Õ´®¿ÚÖÐ¶Ï£¬·ñÔò·¢ËÍ²»ÕýÈ·
 632   1         for(i=0;i<5;i++)  //²éÑ¯·½Ê½·¢ËÍÊý¾Ý
 633   1         {
 634   2             TI=0;
 635   2             SBUF=cmd[i];
 636   2             while(TI==0);
 637   2         }
 638   1         TI=0;
 639   1         ES=1;
 640   1      }
 641          
C51 COMPILER V7.02a   MAIN                                                                 01/15/2015 15:58:45 PAGE 12  

 642          
 643          /*´ÓEEPROMÖÐ¶ÁÒ»¸ö×Ö½ÚÊý¾Ý---*/
 644          void ReadOneByteFromEpprom()
 645          {
 646   1          unsigned char i;
 647   1          unsigned char cmd[6]={0xaa ,0xbb,0x03,0x58,0x00,0x00};
 648   1          unsigned char checksum=0x00;
 649   1          unsigned char Haddr;
 650   1          unsigned char Laddr;
 651   1          unsigned char da;
 652   1          Haddr=recv_buf[2];
 653   1          Laddr=recv_buf[3];
 654   1          da=ReadEEPROM(Haddr,Laddr);
 655   1          cmd[4]=da;
 656   1          
 657   1          for(i=0;i<3;i++)
 658   1          {
 659   2             checksum=checksum^cmd[i+2];
 660   2          }
 661   1          cmd[5]=checksum;
 662   1          //»ØËÍÖ¸Áî
 663   1          ES=0;            //Ê¹ÓÃ²éÑ¯·½Ê½·¢ËÍ´®¿ÚÊý¾ÝÊ±£¬Òª¹Ø±Õ´®¿ÚÖÐ¶Ï£¬·ñÔò·¢ËÍ²»ÕýÈ·
 664   1          for(i=0;i<6;i++) //²éÑ¯·½Ê½·¢ËÍÊý¾Ý
 665   1          {
 666   2             TI=0;
 667   2             SBUF=cmd[i];
 668   2             while(TI==0);
 669   2          }
 670   1          TI=0;
 671   1          ES=1;
 672   1      }
 673          
 674          
 675          /*---Õë¶ÔEEPROMµÄ²Ù×÷ÇëÇó´¦Àíº¯Êý---*/
 676          bool EppromHandle()
 677          {
 678   1         unsigned char CmdWord=recv_buf[1]; //»ñÈ¡Ö¸ÁîµÄÃüÁî×Ö
 679   1         if(CmdWord==0x50)                  //¶Á¿¨EEPROMÖÐµÄÒ»¸ö¿¨ÐòÁÐºÅ
 680   1         {
 681   2            ReadCardSnFromEppromToPC();
 682   2            return TRUE;
 683   2         }
 684   1         else if(CmdWord==0x52)             //ÏòEEPROMÖÐÐ´Ò»¸ö¿¨µÄÐòÁÐºÅ
 685   1         {
 686   2            WriteCardSnToEeprom();         
 687   2            return TRUE;
 688   2         }
 689   1         else if(CmdWord==0x54)            //²Á³ýEEPROMµÄÒ»¸öÉÈÇø
 690   1         {
 691   2           EraseSectorOfEpprom();
 692   2           return TRUE;
 693   2         }
 694   1         else if(CmdWord==0x58)            //¶ÁEEPROMÖÐµÄÒ»¸ö×Ö½Ú
 695   1         {
 696   2           ReadOneByteFromEpprom();
 697   2           return TRUE;
 698   2         }
 699   1         else if(CmdWord==0x5a)
 700   1         {
 701   2            WriteOneByteToEpprom();        //ÏòEEPROMÖÐ¶ÁÒ»¸ö×Ö½Ú
 702   2            return TRUE;
 703   2         }
C51 COMPILER V7.02a   MAIN                                                                 01/15/2015 15:58:45 PAGE 13  

 704   1         else
 705   1         {
 706   2            return FALSE;
 707   2         }
 708   1      }
 709          /*--------------------------------------------------------------------------------------------------------
             ------------------------*/
 710          
 711          
 712          
 713          
 714             
 715          /*-------------------------------------------------------------ÆäËû---------------------------------------
             ------------------------*/
 716          /*---¶Ô»º´ærecv_bufÇåÁã---*/
 717            //Çå³ýµôÉÏ´Î½ÓÊÕµÄÊý¾Ý
 718          void ClearBuf()
 719          {
 720   1          int i;
 721   1          for(i=0;i<max_num;i++)
 722   1          {
 723   2              recv_buf[i]=0x0;
 724   2          }
 725   1      }
 726          
 727          /*---ÑÓÊ±º¯Êý---*/
 728          void Delay(int m,int n)
 729          {
 730   1         int i,j;
 731   1         for(i=0;i<m;i++)
 732   1         {
 733   2            WDTFunction();//Î¹¹·
 734   2            for(j=0;j<n;j++){}
 735   2         }
 736   1      }  
 737          
 738          /*---¿´ÃÅ¹·º¯Êý---*/
 739          void WDTFunction()
 740          {
 741   1         WDT=0x3e;
 742   1      }
 743          /*--------------------------------------------------------------------------------------------------------
             -----------------------*/
 744          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1739    ----
   CONSTANT SIZE    =     60    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     34      82
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
